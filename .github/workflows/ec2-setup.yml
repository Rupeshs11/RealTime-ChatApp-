name: Initial EC2 Setup

on:
  workflow_dispatch:

jobs:
  setup:
    name:  Setup EC2 Instance
    runs-on: ubuntu-latest

    steps:
      - name: Install Docker & Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 5m
          script: |
            # Update system
            sudo yum update -y

            # Install Docker
            sudo yum install -y docker
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG docker ec2-user

            # Install Docker Compose plugin
            sudo mkdir -p /usr/local/lib/docker/cli-plugins
            sudo curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 \
              -o /usr/local/lib/docker/cli-plugins/docker-compose
            sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

            # Verify
            docker --version
            docker compose version

            echo "Docker installed!"

      - name: Install Certbot & Get SSL Certificate
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 5m
          script: |
            # Install Certbot
            sudo yum install -y certbot

            # Get SSL certificate (standalone mode)
            sudo certbot certonly --standalone --non-interactive --agree-tos \
              --email ${{ secrets.CERT_EMAIL }} \
              -d knoxcloud.tech -d www.knoxcloud.tech

            echo "✅ SSL certificate obtained!"

      - name: Create Project Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p ~/knoxchat/nginx
            echo "✅ Project directory created!"
            echo "EC2 is ready for deployment!"
